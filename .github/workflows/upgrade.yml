name: Upgrade dependencies

on:
  push:
    branches:
      - "feature/*"
      - "upgrade/*"
      - "fix/*"
  pull_request:
    branches:
      - staging

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5.0.0
      - uses: oven-sh/setup-bun@v2.0.2
      - run: bun install --frozen-lockfile
      - run: cd client && bun run build
      - run: cd server && bun run start &

  notify-upgrade-success:
    if: success() && contains(github.ref, 'upgrade/')
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: dataesr/mm-notifier-action@v1.0.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN}}
          mattermost_webhook_url: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          mattermost_channel: bots
          message: |
            ğŸš€âœ¨ **UPGRADE MAGIQUE RÃ‰USSIE !** âœ¨ğŸš€

            ğŸ§™â€â™‚ï¸ Le sorcier des dÃ©pendances vient de terminer son rituel sur `${{ github.ref_name }}`

            ğŸ¯ **RÃ©sultats du sortilÃ¨ge :**
            â€¢ âœ… Client builÃ© avec la puissance de Vite 7.x
            â€¢ âœ… Serveur Elysia 1.4.15 prÃªt au combat
            â€¢ âœ… Bun 1.3.1 fait vrooom vrooom
            â€¢ âœ… Toutes les vulnÃ©rabilitÃ©s ont fui comme des vampires au soleil ğŸ§›â€â™‚ï¸â˜€ï¸

            ğŸ‰ Commit: `${{ github.sha }}`
            ğŸ‘¤ Auteur: @${{ github.actor }}

            *Prochaine Ã©tape : merger vers staging quand tu seras prÃªt ! ğŸŠ*

  notify-upgrade-failure:
    if: failure() && contains(github.ref, 'upgrade/')
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: dataesr/mm-notifier-action@v1.0.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN}}
          mattermost_webhook_url: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          mattermost_channel: bots
          message: |
            ğŸ’¥ğŸ”¥ **OUPS ! L'UPGRADE A EXPLOSÃ‰ !** ğŸ”¥ğŸ’¥

            ğŸ¤– Bip boop... erreur dÃ©tectÃ©e sur `${{ github.ref_name }}`

            ğŸ˜… **Diagnostic du carnage :**
            â€¢ ğŸ”´ Quelque chose a pÃ©tÃ© pendant l'upgrade
            â€¢ ğŸš¨ Les dÃ©pendances font la grÃ¨ve
            â€¢ ğŸ“¦ Bun fait des caprices
            â€¢ ğŸ¤” Ou alors c'est juste la faute de JavaScript...

            ğŸ”§ **Plan de sauvetage :**
            1. VÃ©rifier les logs GitHub Actions
            2. Tester en local avec `bun start`
            3. Peut-Ãªtre faire un `bun install` magique ?

            ğŸ’ª Commit foireux: `${{ github.sha }}`
            ğŸ¦¸â€â™‚ï¸ Responsable: @${{ github.actor }}

            *Courage ! MÃªme les meilleurs upgrades ratent parfois ! ğŸ¤*
            *10 pompes Ã  faire!ğŸ¤*

  notify-other-failure:
    if: failure() && !contains(github.ref, 'upgrade/')
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: dataesr/mm-notifier-action@v1.0.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN}}
          mattermost_webhook_url: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          mattermost_channel: dev-alerts
          message: "âŒ Build failed on branch ${{ github.ref_name }} by @${{ github.actor }}"
